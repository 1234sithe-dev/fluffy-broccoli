@model OKRPerformanceManagement.Models.PerformanceReview

@{
    ViewData["Title"] = "View OKR";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">OKR Details</h1>
                <div>
                    @if (Model != null)
                    {
                        @if (Model.Status == "Draft" || Model.Status == "Employee_Review")
                        {
                            <a href="@Url.Action("EditOKR", new { id = Model.Id })" class="btn btn-primary">
                                <i class="fas fa-edit"></i> Edit OKR
                            </a>
                        }
                        @if (Model.Status == "Manager_Review" || Model.Status == "Discussion")
                        {
                            <a href="@Url.Action("ReviewDetails", new { id = Model.Id })" class="btn btn-warning">
                                <i class="fas fa-clipboard-check"></i> Review Details
                            </a>
                        }
                        @if (Model.Status == "Completed" || Model.Status == "Signed")
                        {
                            <a href="@Url.Action("DownloadPDF", new { id = Model.Id })" class="btn btn-success">
                                <i class="fas fa-download"></i> Download PDF
                            </a>
                        }
                    }
                    <a href="@Url.Action("MyOKRs")" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to My OKRs
                    </a>
                </div>
            </div>
        </div>
    </div>

    @if (Model != null)
    {
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Position / Role:</strong> @(Model.OKRTemplate?.Role ?? "Administration or Jnr Support Engineer")
                            </div>
                            <div class="col-md-4">
                                <strong>Line of Business:</strong> Digital Industries - CSI3
                            </div>
                            <div class="col-md-4">
                                <strong>Financial Year:</strong> FY @DateTime.Now.Year
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OKR Template Structure -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">OKR Performance Review</h6>
                    </div>
                    <div class="card-body">
                        <!-- Objectives and Key Results Table -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead class="thead-dark">
                                    <tr>
                                        <th rowspan="2">Objective</th>
                                        <th rowspan="2">KR Weight</th>
                                        <th rowspan="2">OKR Name</th>
                                        <th rowspan="2">Target</th>
                                        <th rowspan="2">Measure</th>
                                        <th rowspan="2">Objectives</th>
                                        <th rowspan="2">Measurement/Tracking Source</th>
                                        <th rowspan="2">Final Weighting</th>
                                        <th colspan="3" class="text-center">Rating</th>
                                        <th rowspan="2">Comments</th>
                                    </tr>
                                    <tr>
                                        <th>Manager</th>
                                        <th>Employee</th>
                                        <th>Final</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.Objectives != null && Model.Objectives.Any())
                                    {
                                        @foreach (var objective in Model.Objectives)
                                        {
                                            <tr>
                                                <td rowspan="@(objective.KeyResults?.Count ?? 1)" class="align-middle">
                                                    <strong>@objective.Name</strong>
                                                </td>
                                                <td rowspan="@(objective.KeyResults?.Count ?? 1)" class="align-middle text-center">
                                                    @objective.Weight.ToString("F2")%
                                                </td>
                                                @if (objective.KeyResults != null && objective.KeyResults.Any())
                                                {
                                                    var firstKR = objective.KeyResults.First();
                                                    <td>@firstKR.Name</td>
                                                    <td>@firstKR.Target</td>
                                                    <td>@firstKR.Measure</td>
                                                    <td>@firstKR.Objectives</td>
                                                    <td>@firstKR.MeasurementSource</td>
                                                    <td class="text-center">@firstKR.Weight.ToString("F2")%</td>
                                                    <td class="text-center">
                                                        @if (firstKR.ManagerRating.HasValue)
                                                        {
                                                            <span class="badge badge-info">@firstKR.ManagerRating.Value</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td class="text-center">
                                                        @if (firstKR.EmployeeRating.HasValue)
                                                        {
                                                            <span class="badge badge-warning">@firstKR.EmployeeRating.Value</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td class="text-center">
                                                        @if (firstKR.FinalRating.HasValue)
                                                        {
                                                            <span class="badge badge-success">@firstKR.FinalRating.Value</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>@(firstKR.FinalComments ?? firstKR.ManagerComments ?? firstKR.EmployeeComments ?? "")</td>
                                                }
                                                else
                                                {
                                                    <td colspan="8" class="text-center text-muted">No Key Results</td>
                                                }
                                            </tr>
                                            @if (objective.KeyResults != null && objective.KeyResults.Count > 1)
                                            {
                                                @for (int i = 1; i < objective.KeyResults.Count; i++)
                                                {
                                                    var kr = objective.KeyResults.ToList()[i];
                                                    <tr>
                                                        <td>@kr.Name</td>
                                                        <td>@kr.Target</td>
                                                        <td>@kr.Measure</td>
                                                        <td>@kr.Objectives</td>
                                                        <td>@kr.MeasurementSource</td>
                                                        <td class="text-center">@kr.Weight.ToString("F2")%</td>
                                                        <td class="text-center">
                                                            @if (kr.ManagerRating.HasValue)
                                                            {
                                                                <span class="badge badge-info">@kr.ManagerRating.Value</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">-</span>
                                                            }
                                                        </td>
                                                        <td class="text-center">
                                                            @if (kr.EmployeeRating.HasValue)
                                                            {
                                                                <span class="badge badge-warning">@kr.EmployeeRating.Value</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">-</span>
                                                            }
                                                        </td>
                                                        <td class="text-center">
                                                            @if (kr.FinalRating.HasValue)
                                                            {
                                                                <span class="badge badge-success">@kr.FinalRating.Value</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">-</span>
                                                            }
                                                        </td>
                                                        <td>@(kr.FinalComments ?? kr.ManagerComments ?? kr.EmployeeComments ?? "")</td>
                                                    </tr>
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="12" class="text-center text-muted">No Objectives Found</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr class="table-info">
                                        <td colspan="7" class="text-right"><strong>Must add up to 100</strong></td>
                                        <td class="text-center"><strong>100%</strong></td>
                                        <td colspan="4"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- Sign-Off and Acceptance Section -->
                        <div class="row mt-5">
                            <div class="col-12">
                                <h5 class="mb-3">Sign-Off and Acceptance:</h5>
                                <p class="text-muted mb-4">Before signing this document, verify that the content you are signing is correct.</p>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="border p-3">
                                            <h6><strong>Line Manager</strong></h6>
                                            <div class="row">
                                                <div class="col-6">
                                                    <p><strong>Name:</strong> @(Model.Manager?.FirstName ?? "Manager Name") @(Model.Manager?.LastName ?? "")</p>
                                                </div>
                                                <div class="col-6">
                                                    <p><strong>Date:</strong> @DateTime.Now.ToString("dd/MM/yyyy")</p>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <p><strong>Signature:</strong></p>
                                                <div class="border-bottom" style="height: 50px;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="border p-3">
                                            <h6><strong>Employee</strong></h6>
                                            <div class="row">
                                                <div class="col-6">
                                                    <p><strong>Name:</strong> @(Model.Employee?.FirstName ?? "Your name") @(Model.Employee?.LastName ?? "")</p>
                                                </div>
                                                <div class="col-6">
                                                    <p><strong>Date:</strong> @DateTime.Now.ToString("dd/MM/yyyy")</p>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <p><strong>Signature:</strong></p>
                                                <div class="border-bottom" style="height: 50px;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- EPM Section -->
                        <div class="row mt-5">
                            <div class="col-12">
                                <h5 class="mb-3">EPM</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Objective</th>
                                                <th>Rating</th>
                                                <th>Allocation</th>
                                                <th>Calculation</th>
                                                <th>On EPM</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (Model.Objectives != null && Model.Objectives.Any())
                                            {
                                                @foreach (var objective in Model.Objectives)
                                                {
                                                    // Calculate average final rating from key results
                                                    var keyResultsWithRating = objective.KeyResults?.Where(kr => kr.FinalRating.HasValue).ToList();
                                                    var averageFinalRating = keyResultsWithRating?.Any() == true ? keyResultsWithRating.Average(kr => kr.FinalRating.Value) : (double?)null;
                                                    var hasAnyFinalRating = keyResultsWithRating?.Any() == true;
                                                    <tr>
                                                        <td>@objective.Name</td>
                                                        <td class="text-center">
                                                            @if (hasAnyFinalRating && averageFinalRating.HasValue)
                                                            {
                                                                <span class="badge badge-success">@averageFinalRating.Value.ToString("F1")</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">-</span>
                                                            }
                                                        </td>
                                                        <td class="text-center">@objective.Weight.ToString("F2")%</td>
                                                        <td class="text-center">
                                                            @if (hasAnyFinalRating && averageFinalRating.HasValue)
                                                            {
                                                                @((objective.Weight * (decimal)averageFinalRating.Value / 100).ToString("F0"))
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">-</span>
                                                            }
                                                        </td>
                                                        <td class="text-center">
                                                            @if (hasAnyFinalRating && averageFinalRating.HasValue && averageFinalRating.Value >= 3)
                                                            {
                                                                <span class="badge badge-success">MET</span>
                                                            }
                                                            else if (hasAnyFinalRating && averageFinalRating.HasValue)
                                                            {
                                                                <span class="badge badge-danger">NOT MET</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">-</span>
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-gray-600">OKR Not Found</h5>
                        <p class="text-muted">The requested OKR could not be found or loaded.</p>
                        @if (ViewBag.ErrorMessage != null)
                        {
                            <div class="alert alert-warning mt-3">
                                <strong>Error:</strong> @ViewBag.ErrorMessage
                            </div>
                        }
                        @if (ViewBag.DebugInfo != null)
                        {
                            <div class="alert alert-info mt-3">
                                <strong>Debug Info:</strong> @ViewBag.DebugInfo
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Add any additional JavaScript functionality here
            console.log('ViewOKR page loaded successfully');
        });
    </script>
}